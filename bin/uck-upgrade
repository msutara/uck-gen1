#!/bin/bash
# UCK Gen1 Debian Upgrade — Main Entrypoint
#
# Upgrades a Ubiquiti Cloud Key Gen1 through Debian releases:
# Jessie → Stretch → Buster → Bullseye → Bookworm
#
# See docs/HOW-IT-WORKS.md for architecture details.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(cd "$SCRIPT_DIR/../lib" && pwd)"

# shellcheck source=../lib/common.sh
source "$LIB_DIR/common.sh"

UCK_CONTINUATION_CMD="bash $SCRIPT_DIR/uck-upgrade"

# Source all release scripts
for release_script in "$LIB_DIR"/releases/*.sh; do
    # shellcheck source=/dev/null
    source "$release_script"
done

trap ctrl_c INT
ctrl_c() {
    log "Interrupted — triggering factory reset"
    ubnt-systool reset2defaults
}

usage() {
    cat <<EOF
Usage: uck-upgrade [OPTIONS]

Headless Debian upgrade for Ubiquiti Cloud Key Gen1.
Upgrades through: Jessie → Stretch → Buster → Bullseye → Bookworm

Options:
  --dry-run     Show what would happen without making changes
  --keep-packages
                Keep optional packages and skip final slimming purge
  --status      Show current upgrade state and recent log entries
  --version     Show version
  -h, --help    Show this help message

EOF
}

show_status() {
    local state
    state="$(get_current_state)"

    if [[ -z "$state" ]]; then
        echo "Status: Upgrade complete (or not started)"
    else
        echo "Status: Next stage is '$state'"
    fi

    echo ""
    echo "Current OS:"
    lsb_release -a 2>/dev/null || cat /etc/os-release 2>/dev/null || echo "Unknown"

    if [[ -f "$UCK_LOG_FILE" ]]; then
        echo ""
        echo "Recent log entries:"
        tail -20 "$UCK_LOG_FILE"
    fi
}

# --- Parse arguments ---

# shellcheck disable=SC2034  # DRY_RUN/KEEP_PACKAGES are used by lib/common.sh functions
while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --keep-packages)
            KEEP_PACKAGES=true
            shift
            ;;
        --status)
            show_status
            exit 0
            ;;
        --version)
            echo "uck-upgrade $UCK_VERSION"
            exit 0
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage >&2
            exit 1
            ;;
    esac
done

# --- Pre-flight checks ---

check_root

export DEBIAN_FRONTEND=noninteractive
echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections

# --- Detect initial Jessie state ---

bootstrap_state=""
current_state="$(get_current_state)"
mapfile -t source_releases < <(
    awk '$1=="deb"{split($3, rel, "/"); print rel[1]}' "$UCK_SOURCES_LIST" 2>/dev/null | sort -u
)

if [[ -z "$current_state" &&
      ${#source_releases[@]} -eq 1 &&
      "${source_releases[0]}" == "jessie" ]]; then
    if [[ "$DRY_RUN" == true ]]; then
        log "[DRY-RUN] Bootstrapping initial state in-memory: jessie"
        bootstrap_state="jessie"
    else
        set_next_state "jessie"
    fi
fi

# --- Determine current state and run ---

log "uck-upgrade $UCK_VERSION starting"
lsb_release -a 2>/dev/null || true

load_state_options
state="$(get_current_state)"
if [[ -z "$state" && -n "$bootstrap_state" ]]; then
    state="$bootstrap_state"
fi

if [[ -n "$state" ]]; then
    ensure_rc_local_continuation "$UCK_CONTINUATION_CMD"
fi

if [[ -n "$state" && "$state" != "finalize" ]]; then
    check_network
fi

if [[ -z "$state" ]]; then
    log "Latest tested version installed — nothing to do."
else
    log "Starting upgrade stage: $state"
    "$state"
fi
